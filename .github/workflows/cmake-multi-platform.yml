# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: Windows Build
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        build_type: [Release]
        c_compiler: [cl]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Vulkan SDK
      uses: humbletim/install-vulkan-sdk@v1.2
      with:
        version: 1.4.313.0
        cache: true
    
    - name: Set Vulkan Environment Variables
      run: |
        echo "VULKAN_SDK=${{ env.VULKAN_SDK }}" >> $GITHUB_ENV
        echo "VK_SDK_PATH=${{ env.VULKAN_SDK }}" >> $GITHUB_ENV
        echo "${{ env.VULKAN_SDK }}/bin" >> $GITHUB_PATH
      shell: bash
      
    - name: Cache Qt 6.9.0
      id: cache-qt
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/Qt
        key: qt-6.9.0-windows-msvc2022-x64
        
    - name: Install Qt 6.9.0
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'
        dir: '${{ github.workspace }}/Qt'
        install-deps: 'true'
        modules: 'qtwebengine qtwebchannel qtpositioning'
        cache: 'true'
        
    - name: Setup Ninja
      uses: ashutoshvarma/setup-ninja@master
      with:
        # ninja version to download. Default: 1.10.0
        version: 1.11.1
        
    # Use the newer setup-msbuild action that properly initializes the MSVC environment
    - name: Setup MSVC
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Explore Vulkan SDK Directory
      shell: bash
      run: |
        echo "==================== VULKAN SDK EXPLORER ===================="
        echo "Exploring: ${{ env.VULKAN_SDK }}"
        echo "=============================================================="
        if [ ! -d "${{ env.VULKAN_SDK }}" ]; then
          echo "âŒ ERROR: Directory does not exist: ${{ env.VULKAN_SDK }}"
          exit 1
        fi
        echo "âœ… Directory exists!"
        echo ""
        echo "ðŸ“‹ ROOT CONTENTS:"
        ls -la "${{ env.VULKAN_SDK }}"
        echo ""
        echo "ðŸ“ BIN DIRECTORY:"
        if [ -d "${{ env.VULKAN_SDK }}/bin" ]; then
          ls -la "${{ env.VULKAN_SDK }}/bin"
        else
          echo "âŒ bin directory not found"
        fi
        echo ""
        echo "ðŸ“ LIB DIRECTORY:"
        if [ -d "${{ env.VULKAN_SDK }}/lib" ]; then
          ls -la "${{ env.VULKAN_SDK }}/lib"
        else
          echo "âŒ lib directory not found"
        fi
        echo ""
        echo "ðŸ“ INCLUDE DIRECTORY:"
        if [ -d "${{ env.VULKAN_SDK }}/include" ]; then
          ls -la "${{ env.VULKAN_SDK }}/include"
          echo ""
          echo "ðŸ“ INCLUDE/VULKAN:"
        if [ -d "${{ env.VULKAN_SDK }}/include/vulkan" ]; then
            ls -la "${{ env.VULKAN_SDK }}/include/vulkan"
        fi
        else
          echo "âŒ include directory not found"
        fi
        echo ""
        echo "ðŸŒ³ COMPLETE DIRECTORY TREE:"
        find "${{ env.VULKAN_SDK }}" -type d 2>/dev/null | head -20
        echo ""
        echo "ðŸ” SEARCHING FOR VULKAN LIBRARIES:"
        find "${{ env.VULKAN_SDK }}" -name "*vulkan*" -type f 2>/dev/null | head -10
        echo ""
        echo "ðŸ”§ ENVIRONMENT VARIABLES:"
        echo "VULKAN_SDK: ${{ env.VULKAN_SDK }}"
        echo "VULKAN_SDK_VERSION: ${{ env.VULKAN_SDK_VERSION }}"
        echo "VULKAN_SDK_PLATFORM: ${{ env.VULKAN_SDK_PLATFORM }}"
        echo ""
        echo "=============================================================="
        echo "Exploration complete!"
      
    - name: Configure CMake
      run: |
        cmake -B cmake-build `
          -DCMAKE_CXX_COMPILER="${{ matrix.cpp_compiler }}" `
          -DCMAKE_C_COMPILER="${{ matrix.c_compiler }}" `
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
          -DCMAKE_BUILD_TYPE="${{ matrix.build_type }}" `
          -DVulkan_ROOT="${{ env.VULKAN_SDK }}" `
          -DVulkan_LIBRARY="${{ env.VULKAN_SDK }}/lib/vulkan-1.lib" `
          -DVulkan_INCLUDE_DIR="${{ env.VULKAN_SDK }}/include" `
          -S "${{ github.workspace }}"
        
    - name: Build
      run: cmake --build cmake-build --parallel
      
    - name: Test
      working-directory: cmake-build
      run: ctest --output-on-failure --parallel
